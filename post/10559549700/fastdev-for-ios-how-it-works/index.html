
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>FastDev for iOS: how it works  | Titanium Ninja</title>

<meta name="author" content="TiNinja">

<meta name="description" content="Some days ago I published a hack that allows patching the Titanium Mobile SDK for enabling fast on-device testing of iOS applications, without &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="http://feeds.feedburner.com/TitaniumNinja" rel="alternate" title="Titanium Ninja" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Titanium Ninja</a></h1>
<h4>Hacking Titanium Mobile for fun and profit</h4>
<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/whoami/">Whoami</a></li>
  <li><a href="/talks">Talks</a></li>
  <li><a href="http://feeds.feedburner.com/TitaniumNinja">RSS</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/whoami/">Whoami</a></li>
  <li><a href="/talks">Talks</a></li>
  <li><a href="http://feeds.feedburner.com/TitaniumNinja">RSS</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:titaniumninja.com">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">FastDev for iOS: How It Works</h2>
	<div class="entry-content"><p>Some days ago I <a href="http://titaniumninja.com/post/10360108035/titanium-hack-fastdev-for-ios">published</a> a hack that allows patching the Titanium Mobile SDK for enabling fast on-device testing of iOS applications, without needing to rebuild, sign and redeploy them.</p>



<p>With this post I&#8217;d like to share some of the inner workings of the Titanium sdk that make that hack possible. I also try to explain in more detail how the hack works, so you may want to check out its source code at <a href="https://github.com/omorandi/TiiOSFastDev"><a href="https://github.com/omorandi/TiiOSFastDev">https://github.com/omorandi/TiiOSFastDev</a></a>.</p>



<p>First, I need to say that, in contrast to what many developers believe when they first approach Titanium Mobile, the JavaScript files that compose an application are not compiled to native code. Instead they get interpreted by a JavaScript engine: a slightly modified version of <a href="http://">JavaScriptCore</a> on iOS (i.e. the engine used by WebKit), and <a href="http://www.mozilla.org/rhino/">Rhino</a> (which will be hopefully soon replaced by  <a href="http://code.google.com/p/v8/">V8</a>) on Android.</p>



<p>When deploying an application on the iOS emulator, the JS engine gets fed directly with the original files that reside in the <code>Resources</code> directory of your app project, loaded at runtime. This allows you for example to see the changes you made in one file, by just restarting the app in the emulator.</p>



<p>On the other hand, when deploying on the device, the original source files are processed and packed into a single file, just before building the app.

This step generates the <code>build/iphone/Classes/ApplicationRouting.m</code> file, which is one of the very few that are dynamically generated by the build process. Indeed, most of the objective-c files that compose the native app are simply copied from the appropriate Ti SDK directory (e.g. <code>/Library/Application\ Support/Titanium/mobilesdk/osx/1.8.0</code>) into the <code>build/iphone</code> directory of the project by the titanium build scripts when you launch the app from Ti Studio, or from the command line.</p>



<p>Once generated, <code>ApplicationRouting.m</code> contains the definition of a dictionary object that associates the name of each JS file present in the Resources directory of your project with a binary representation of its original content, along with a single class method named <code>resolveAppAsset:</code> whose only purpose is to return the appropriate file content for a given path:</p>


<figure class='code'><figcaption><span>ApplicationRouting.m</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSData</span><span class="o">*</span><span class="p">)</span> <span class="nf">resolveAppAsset:</span><span class="p">(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="nv">path</span><span class="p">;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">==</span><span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">map</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableDictionary</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="c1">//here the entry for app.js is created</span>
</span><span class='line'>        <span class="c1">//(I filled the hex string with garbage - it&#39;s only an example)</span>
</span><span class='line'>        <span class="p">[</span><span class="n">map</span> <span class="nl">setObject:</span><span class="n">dataWithHexString</span> <span class="s">@&quot;DEADBEEFâ€¦&quot;</span> <span class="nl">forKey:</span><span class="s">@&quot;app_js&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//here the content of the file at &quot;path&quot; is returned to the caller</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">map</span> <span class="nl">objectForKey:</span><span class="n">path</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>In other words, this portion of code represents the point where the original content of each JS file is dispatched to the Titanium runtime environment, which will then feed it to the JSCore interpreter.</p>



<p>As you surely understand at this point, the FastDev hack is made possible by simply using a modified version of the <code>resolveAppAsset</code> method, which, instead of returning static data, opens a connection to an HTTP server running on the development machine for retrieving the original JS files from the Resources directory:</p>


<figure class='code'><figcaption><span>ApplicationRouting.m (modified version)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSData</span><span class="o">*</span><span class="p">)</span> <span class="nf">resolveAppAsset:</span><span class="p">(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="nv">path</span><span class="p">;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">ServerAddr</span> <span class="o">=</span> <span class="n">SERVER_ADDRESS</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">ServerPort</span> <span class="o">=</span> <span class="n">SERVER_PORT</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">path_url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;http://%@:%@/%@&quot;</span><span class="p">,</span><span class="n">ServerAddr</span><span class="p">,</span> <span class="n">ServerPort</span><span class="p">,</span> <span class="n">path</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">path_url</span><span class="p">];</span>
</span><span class='line'>    <span class="n">ASIHTTPRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">ASIHTTPRequest</span> <span class="nl">requestWithURL:</span><span class="n">url</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">request</span> <span class="n">startSynchronous</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="n">request</span> <span class="n">responseStatusCode</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">request</span> <span class="n">error</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">request</span> <span class="n">responseData</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



<ol><li><p>Since the method is called synchronously, also the HTTP request must be performed in a synchrounous way:</p>



<p><code>[request startSynchronous];</code></p></li>

<li><p>For testing the application on the iOS emulator, the request to the server can be made on <code>localhost</code>, however, for on-device testing, we need to know in advance the IP address at which we the server can be reached, because the modified <code>ApplicationRouting.m</code> will be built into the native application running on the target device. This is achieved through a simple trick in the startserver.py script:</p></li>

</ol>

<figure class='code'><figcaption><span>startserver.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">ip_addr</span> <span class="o">=</span> <span class="s">&quot;localhost&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;gmail.com&quot;</span><span class="p">,</span><span class="mi">80</span><span class="p">))</span>
</span><span class='line'>    <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'><span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span>
</span><span class='line'>    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>
</span></code></pre></td></tr></table></div></figure>

<p>This code allows discovering the local IP address that routes to the Internet (specifically to gmail.com), so I make the assumption that the iPhone/iPad used for testing and the development machine reside both on the same local network and that the IP address of the Mac machine on that network is also the one that routes it to the Internet.</p>



<p>So the <code>startserver.py</code> script uses this information for patching the <code>build/iphone/Classes/ServerAddr.h</code> file containing  the <code>SERVER_ADDRESS</code> define, which is used in <code>ApplicationRouting.m</code> for creating the HTTP request. This is also why the <code>startserver.py</code> script needs to be launched before building the app.</p>



<p>That&#8217;s it!</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2011-09-23T00:00:00+02:00" pubdate data-updated="true">Sep 23<span>rd</span>, 2011</time></div>
	


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    TiNinja

<br>
Powered by Octopress. Theme inspired by <a href="https://github.com/macjasp/cleanpress">CleanPress</a>
</footer>
	

<script type="text/javascript">
      var disqus_shortname = 'tininja';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-8810685-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
